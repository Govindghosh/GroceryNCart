version: '3.8'

services:
  # =====================
  # Backend Server
  # =====================
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: production
    container_name: groceryncart-server
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ./server/.env
    networks:
      - groceryncart-network
    volumes:
      - ./server/src:/app/src:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', r => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # Frontend Client
  # =====================
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      target: production
    container_name: groceryncart-client
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - server
    networks:
      - groceryncart-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =====================
  # Nginx Reverse Proxy
  # =====================
  nginx:
    image: nginx:alpine
    container_name: groceryncart-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - certbot_www:/var/www/certbot:ro
      - certbot_conf:/etc/letsencrypt:ro
    depends_on:
      - client
      - server
    networks:
      - groceryncart-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # Certbot (SSL Renew)
  # =====================
  certbot:
    image: certbot/certbot:latest
    container_name: groceryncart-certbot
    volumes:
      - certbot_www:/var/www/certbot:rw
      - certbot_conf:/etc/letsencrypt:rw
    entrypoint: >
      /bin/sh -c "trap exit TERM;
      while :; do
        certbot renew;
        sleep 12h & wait $${!};
      done;"
    profiles:
      - production

networks:
  groceryncart-network:
    driver: bridge

volumes:
  certbot_www:
    driver: local
  certbot_conf:
    driver: local
